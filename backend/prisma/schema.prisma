// Mental Health Platform - PostgreSQL Schema
// Database: Production-grade relational data for users, appointments, payments
// MongoDB handles: Chat messages, crisis logs, unstructured notes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE USER MANAGEMENT
// ============================================================================

enum UserRole {
  PATIENT
  THERAPIST
  ADMIN
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
  PENDING_VERIFICATION
}

model User {
  id                String        @id @default(uuid())
  email             String        @unique
  passwordHash      String?       // Nullable for OAuth users
  name              String
  phone             String?
  avatar            String?
  role              UserRole      @default(PATIENT)
  accountStatus     AccountStatus @default(ACTIVE)
  
  // OAuth Integration
  googleId          String?       @unique
  appleId           String?       @unique
  
  // Progressive Profiling Data
  dateOfBirth       DateTime?
  gender            String?       // "male", "female", "non-binary", "prefer-not-to-say"
  location          String?       // City/State for therapist matching
  emergencyContact  String?       // JSON: { name: string, phone: string, relation: string }
  
  // Privacy & Consent
  consentedAt       DateTime?
  dataRetentionDays Int           @default(2555) // 7 years (HIPAA default)
  isEmailVerified   Boolean       @default(false)
  isPhoneVerified   Boolean       @default(false)
  
  // Analytics
  lastLoginAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relationships
  therapistProfile  Therapist?
  appointmentsAsPatient Appointment[] @relation("PatientAppointments")
  payments          Payment[]
  consentLogs       ConsentLog[]
  anonymousSession  AnonymousSession?
  moodLogs          MoodLog[]
  crisisEvents      CrisisEvent[]
  
  @@index([email])
  @@index([role, accountStatus])
  @@map("users")
}

// ============================================================================
// CRISIS ESCALATION & INTERVENTION
// ============================================================================

enum CrisisStatus {
  PENDING
  ESCALATED
  RESOLVED
  FALSE_POSITIVE
  IGNORED
}

model CrisisEvent {
  id              String       @id @default(uuid())
  
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  conversationId  String?      // ID of the chat session where this occurred
  
  // Detection Data
  crisisLevel     Int          // 1-10
  sentimentScore  Float?       // -1.0 to 1.0
  keywordsDetected String[]
  
  // Severity
  urgency         String       // "low", "medium", "high", "critical"
  requiresEscalation Boolean   @default(false)
  
  // Workflow
  status          CrisisStatus @default(PENDING)
  actionTaken     String?      // "notified_therapist", "called_emergency", "offered_resources"
  
  // Resolution
  resolutionNotes String?      @db.Text
  resolvedAt      DateTime?
  resolvedBy      String?      // Therapist ID or System
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([userId, status])
  @@index([crisisLevel])
  @@map("crisis_events")
}

// ============================================================================
// THERAPIST PROFILES
// ============================================================================

enum TherapistVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Therapist {
  id                    String                       @id @default(uuid())
  userId                String                       @unique
  user                  User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Professional Details
  licenseNumber         String                       @unique
  licenseState          String                       // e.g., "CA", "NY"
  licenseExpiryDate     DateTime
  specializations       String[]                     // ["Anxiety", "Depression", "PTSD", "Addiction"]
  certifications        String[]                     @default([]) // ["CBT Certified", "Trauma Specialist"]
  bio                   String                       @db.Text
  experienceYears       Int                          @default(0)
  languages             String[]                     // ["English", "Hindi", "Spanish"]
  
  // Verification
  verificationStatus    TherapistVerificationStatus  @default(PENDING)
  verificationDocuments String[]                     // URLs to uploaded PDFs
  verifiedAt            DateTime?
  verifiedBy            String?                      // Admin user ID
  
  // Financials
  hourlyRateUSD         Decimal                      @db.Decimal(10, 2)
  hourlyRateINR         Decimal?                     @db.Decimal(10, 2) // Indian pricing
  currency              String                       @default("INR")
  feeStructure          Json?                        // { individual50: number, couples75: number, consult30: number }
  stripeAccountId       String?                      // For payouts
  razorpayAccountId     String?                      // India-specific
  
  // Availability
  isAcceptingPatients   Boolean                      @default(true)
  maxPatientsPerWeek    Int                          @default(20)
  
  // Ratings & Reviews
  averageRating         Decimal?                     @db.Decimal(3, 2) // e.g., 4.85
  totalReviews          Int                          @default(0)
  
  // Analytics
  totalEarningsUSD      Decimal                      @default(0) @db.Decimal(10, 2)
  totalSessionsCompleted Int                         @default(0)
  
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  
  // Relationships
  appointments          Appointment[]                @relation("TherapistAppointments")
  availability          TherapistAvailability[]
  reviews               TherapistReview[]
  activityLogs          ActivityLog[]
  
  @@index([verificationStatus, isAcceptingPatients])
  @@index([specializations])
  @@map("therapists")
}

// ============================================================================
// THERAPIST AVAILABILITY
// ============================================================================

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model TherapistAvailability {
  id          String    @id @default(uuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  dayOfWeek   DayOfWeek
  startTime   String    // "09:00" (24-hour format)
  endTime     String    // "17:00"
  timezone    String    @default("UTC") // "Asia/Kolkata", "America/New_York"
  
  // Exception handling
  isRecurring Boolean   @default(true)
  exceptionDate DateTime? // Specific date override (e.g., holiday)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([therapistId, dayOfWeek])
  @@map("therapist_availability")
}

// ============================================================================
// APPOINTMENTS & SESSIONS
// ============================================================================

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_PATIENT
  CANCELLED_BY_THERAPIST
  NO_SHOW
}

enum AppointmentType {
  VIDEO_CALL
  AUDIO_CALL
  CHAT_ONLY
  IN_PERSON // Future support
}

model Appointment {
  id                String            @id @default(uuid())
  
  patientId         String
  patient           User              @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  
  therapistId       String
  therapist         Therapist         @relation("TherapistAppointments", fields: [therapistId], references: [id], onDelete: Cascade)
  
  // Scheduling
  scheduledAt       DateTime
  durationMinutes   Int               @default(60)
  timezone          String            @default("UTC")
  
  // Status
  status            AppointmentStatus @default(SCHEDULED)
  type              AppointmentType   @default(VIDEO_CALL)
  
  // Video Call Data (stored temporarily, deleted after session)
  videoRoomId       String?           @unique
  videoCallStartedAt DateTime?
  videoCallEndedAt  DateTime?
  
  // Session Notes (stored in MongoDB for flexibility, this is just a reference)
  sessionNotesId    String?           // References MongoDB `session_notes` collection
  
  // Crisis Escalation
  isCrisisSession   Boolean           @default(false)
  crisisLevel       Int?              // 1-10, copied from ML service
  
  // Cancellation
  cancelledAt       DateTime?
  cancellationReason String?          @db.Text
  
  // Ratings & Feedback
  patientRating     Int?              // 1-5
  therapistRating   Int?              // 1-5
  patientFeedback   String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relationships
  payment           Payment?
  
  @@index([patientId, scheduledAt])
  @@index([therapistId, scheduledAt])
  @@index([status, scheduledAt])
  @@map("appointments")
}

// ============================================================================
// PAYMENTS & BILLING
// ============================================================================

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  RAZORPAY
  STRIPE
  MANUAL
}

model Payment {
  id                String          @id @default(uuid())
  
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  appointmentId     String?         @unique
  appointment       Appointment?    @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  
  // Payment Details
  amountUSD         Decimal         @db.Decimal(10, 2)
  amountINR         Decimal?        @db.Decimal(10, 2) // For Indian therapists
  currency          String          @default("INR")
  status            PaymentStatus   @default(PENDING)
  provider          PaymentProvider @default(RAZORPAY)
  
  // Provider-specific IDs
  razorpayOrderId   String?         @unique
  razorpayPaymentId String?         @unique
  stripePaymentIntent String?       @unique
  
  // Timestamps
  paidAt            DateTime?
  refundedAt        DateTime?
  
  // Metadata
  description       String?         @db.Text
  receiptUrl        String?         // URL to generated invoice
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId, status])
  @@index([status, paidAt])
  @@map("payments")
}

// ============================================================================
// ANONYMOUS SESSIONS (Progressive Profiling)
// ============================================================================

enum AnonymousSessionStatus {
  ACTIVE
  CONVERTED_TO_USER
  EXPIRED
}

model AnonymousSession {
  id                String                 @id @default(uuid())
  
  // Device Fingerprint (for session continuity)
  deviceFingerprint String                 @unique // Generated client-side (e.g., FingerprintJS)
  
  // Temporary Data
  temporaryName     String?                // e.g., "Guest_1234"
  messageCount      Int                    @default(0)
  maxFreeMessages   Int                    @default(5)
  
  // Conversion Tracking
  status            AnonymousSessionStatus @default(ACTIVE)
  convertedUserId   String?                @unique
  convertedUser     User?                  @relation(fields: [convertedUserId], references: [id], onDelete: SetNull)
  convertedAt       DateTime?
  
  // Session Metadata
  initialMessage    String?                @db.Text // First message (for context)
  detectedLanguage  String?                // e.g., "en", "hi"
  detectedEmotion   String?                // e.g., "anxious", "sad"
  
  // Expiration (auto-cleanup)
  expiresAt         DateTime               @default(dbgenerated("NOW() + INTERVAL '7 days'"))
  
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  
  @@index([deviceFingerprint, status])
  @@index([expiresAt]) // For cleanup jobs
  @@map("anonymous_sessions")
}

// ============================================================================
// CONSENT & COMPLIANCE (HIPAA)
// ============================================================================

enum ConsentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  DATA_SHARING
  CRISIS_INTERVENTION
  RECORDING_CONSENT // For video/audio session recording
}

model ConsentLog {
  id            String      @id @default(uuid())
  
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  consentType   ConsentType
  granted       Boolean     @default(true)
  
  // Audit Trail
  ipAddress     String?
  userAgent     String?     @db.Text
  grantedAt     DateTime    @default(now())
  
  // Versioning (for policy changes)
  policyVersion String      @default("1.0")
  
  @@index([userId, consentType])
  @@map("consent_logs")
}

// ============================================================================
// THERAPIST REVIEWS
// ============================================================================

model TherapistReview {
  id          String    @id @default(uuid())
  
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  patientId   String    // User ID (not FK to allow anonymous reviews if needed)
  
  rating      Int       // 1-5
  comment     String?   @db.Text
  isVisible   Boolean   @default(true) // Therapist can request hiding inappropriate reviews
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId, isVisible])
  @@map("therapist_reviews")
}

// ============================================================================
// MOOD TRACKING (Simple version - detailed data in MongoDB)
// ============================================================================

enum MoodType {
  VERY_SAD
  SAD
  NEUTRAL
  HAPPY
  VERY_HAPPY
}

model MoodLog {
  id          String    @id @default(uuid())
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  mood        MoodType
  intensity   Int       // 1-10
  note        String?   @db.Text
  
  // MongoDB sync (detailed analysis stored separately)
  mongoDocId  String?   // Reference to MongoDB document with detailed sentiment analysis
  
  loggedAt    DateTime  @default(now())
  
  @@index([userId, loggedAt])
  @@map("mood_logs")
}

// ============================================================================
// ACTIVITY LOG (Therapist Dashboard)
// ============================================================================

enum ActivityType {
  SESSION_COMPLETED
  SESSION_SCHEDULED
  MESSAGE_SENT
  NOTES_ADDED
  APPOINTMENT_APPROVED
  APPOINTMENT_REJECTED
  PATIENT_ADDED
}

model ActivityLog {
  id              String       @id @default(uuid())
  
  therapistId     String
  therapist       Therapist    @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  actionType      ActivityType
  relatedEntityId String?      // Patient ID, Appointment ID, etc.
  metadata        Json?        // Flexible additional data { patientName: string, sessionDuration: number }
  
  createdAt       DateTime     @default(now())
  
  @@index([therapistId, createdAt])
  @@map("activity_logs")
}
